#!/bin/bash
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
DIRECTORY=$(pwd); BASENAME=$(basename "$(pwd)")
#--------------------------------------------------------------------------------
SOURCE=""; OUTPUT=${BASENAME}; OUTPUT_PATH="zig-out"
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
if [ "${1}" == "." ] || [ "${1}" == "*" ] || [ "${1}" == "all" ]
then
	#--------------------------------------------------------------------------------
	shift
	#--------------------------------------------------------------------------------
	mkdir -p ${OUTPUT_PATH};
	#--------------------------------------------------------------------------------
	for FILENAME in *.zig
	do
		#----------------------------------------
		if [ -f "${FILENAME}" ]
		then
			#----------------------------------------
			echo "${FILENAME}:"
			#----------------------------------------
			$(dirname ${BASH_SOURCE[0]})/zigbuild ${FILENAME}
			#----------------------------------------
			if [ $? -eq 0 ] && [ -d "${OUTPUT_PATH}" ] && [ -f "${OUTPUT_PATH}/${OUTPUT}" ]
			then
				#----------------------------------------
				cd ${OUTPUT_PATH}
				#----------------------------------------
				./${OUTPUT} ${*}
				#----------------------------------------
				cd ..
				#----------------------------------------
			fi
			#----------------------------------------
			echo
			#----------------------------------------
		fi
		#----------------------------------------
	done
	#--------------------------------------------------------------------------------
	exit 0
	#--------------------------------------------------------------------------------
elif [ "${1}" != "" ]
then
	#--------------------------------------------------------------------------------
	if [ -f "${1}" ]
	then
		SOURCE=${1}
	elif [ -f "${1}.zig" ]
	then
		SOURCE=${1}.zig
	else
		echo "invalid source filename: ${FILENAME}"
		exit 1
	fi
	#--------------------------------------------------------------------------------
	shift
	#--------------------------------------------------------------------------------
	$(dirname ${BASH_SOURCE[0]})/zigbuild ${SOURCE}
	#----------------------------------------
	[ "${SOURCE}" != "main.zig" ] && OUTPUT=${SOURCE%.zig}
	#----------------------------------------
	if [ $? -eq 0 ] && [ -d "${OUTPUT_PATH}" ] && [ -f "${OUTPUT_PATH}/${OUTPUT}" ]
	then
		#----------------------------------------
		cd ${OUTPUT_PATH}
		#----------------------------------------
		./${OUTPUT} ${*}
		#----------------------------------------
	fi
	#--------------------------------------------------------------------------------
	exit $?
	#--------------------------------------------------------------------------------
fi
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
if [ -f "Taskfile.yml" ] || [ -f "Taskfile.yaml" ] || [ -f "taskfile.yml" ] || [ -f "taskfile.yaml" ]
then
	#----------------------------------------
	task build
	[ $? -eq 0 ] && task run -- $*
	#----------------------------------------
	exit $?
	#----------------------------------------
elif [ -f "Makefile" ] || [ -f "makefile" ]
then
	#----------------------------------------
	make build
	[ $? -eq 0 ] && make run ARGS="${*}"
	#----------------------------------------
	exit $?
	#----------------------------------------
fi
#--------------------------------------------------------------------------------
$(dirname ${BASH_SOURCE[0]})/zigbuild
#--------------------------------------------------------------------------------
if [ $? -eq 0 ]
then
	if [ -d "${OUTPUT_PATH}" ] && [ -f "${OUTPUT_PATH}/${OUTPUT}" ]
	then
		cd ${OUTPUT_PATH}
		./${OUTPUT} ${*}
	elif [ -d "${OUTPUT_PATH}" ] && [ -d "${OUTPUT_PATH}/bin" ] && [ -f "${OUTPUT_PATH}/bin/${OUTPUT}" ]
	then
		cd ${OUTPUT_PATH}/bin
		./${OUTPUT} ${*}
	fi
fi
#--------------------------------------------------------------------------------
exit $?
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
