#!/bin/bash
#--------------------------------------------------------------------------------
match_libc() { grep -qE '@?cImport|@c(Include|Define|Undef|Struct|Union)|\bstd\.c\b|@import\("std"\)\.c' "$1"; }
LC=""
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
[ "${ZIG_BUILD_MODE}" == "" ] && ZIG_BUILD_MODE="ReleaseSmall"
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
DIRECTORY=$(pwd)
#--------------------------------------------------------------------------------
BASENAME=$(basename "$(pwd)")
#--------------------------------------------------------------------------------
SOURCE=""
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
if [ "${1}" == "." ] || [ "${1}" == "*" ] || [ "${1}" == "all" ]
then
	#----------------------------------------
	shift
	#----------------------------------------
	for FILENAME in *.zig
	do
		#----------------------------------------
		if [ -f "${FILENAME}" ]
		then
			#----------------------------------------
			match_libc ${FiLENAME} && LC="-lc"
			#----------------------------------------
			echo "${FILENAME}:"
			zig run ${FILENAME} ${LC} -O ${ZIG_BUILD_MODE} -- ${*}
			echo
			#----------------------------------------
		fi
		#----------------------------------------
	done
	#--------------------------------------------------------------------------------
	exit 0
	#--------------------------------------------------------------------------------
elif [ "${1}" != "" ]
then
	#----------------------------------------
	if [ -f "${1}" ]
	then
		#----------------------------------------
		SOURCE=${1}; shift
		#----------------------------------------
		match_libc ${SOURCE} && LC="-lc"
		#----------------------------------------
		zig run ${SOURCE} ${LC} -O ${ZIG_BUILD_MODE} -- ${*}
		#----------------------------------------
	else
		#----------------------------------------
		echo "invalid source filename: ${SOURCE}"
		exit 1
		#----------------------------------------
	fi
	#--------------------------------------------------------------------------------
	exit $?
	#--------------------------------------------------------------------------------
else
	#--------------------------------------------------------------------------------
	if [ -f "Taskfile.yml" ] || [ -f "Taskfile.yaml" ] || [ -f "taskfile.yml" ] || [ -f "taskfile.yaml" ]
	then
		#----------------------------------------
		task run -- ${*}
		#----------------------------------------
		exit $?
		#----------------------------------------
	elif [ -f "Makefile" ] || [ -f "makefile" ]
	then
		#----------------------------------------
		make run ARGS="${*}"
		#----------------------------------------
		exit $?
		#----------------------------------------
	elif [ -f "main.zig" ]
	then
		#----------------------------------------
		SOURCE="main.zig"
		#----------------------------------------
	elif [ -f "root.zig" ]
	then
		#----------------------------------------
		SOURCE="root.zig"
		#----------------------------------------
	else
		#----------------------------------------
		if [ -f "${BASENAME}.zig" ]
		then
			#----------------------------------------
			SOURCE="${BASENAME}.zig"
			#----------------------------------------
		else
			#----------------------------------------
			echo "unknown source filename"
			exit 1
			#----------------------------------------
		fi
		#----------------------------------------
	fi
	#--------------------------------------------------------------------------------
fi
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
if [ -f "${SOURCE}" ]
then
	#----------------------------------------
	match_libc ${SOURCE} && LC="-lc"
	#----------------------------------------
	zig run ${SOURCE} ${LC} -O ${ZIG_BUILD_MODE} -- ${*}
	#----------------------------------------
else
	#----------------------------------------
	echo "unknown source filename"
	#----------------------------------------
fi
#--------------------------------------------------------------------------------
exit $?
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------

