#!/bin/bash
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
ZIG=$( [[ $PWD == */zig015/* ]] && echo -n "/usr/local/bin/zig015" || echo -n "/usr/local/bin/zig" )
#--------------------------------------------------------------------------------
match_test() { grep -qE '^\s*test\s+"[^"]*"\s*{\s*$' "$1"; }
match_libc() { grep -qE '@?cImport|@c(Include|Define|Undef|Struct|Union)|\bstd\.c\b|@import\("std"\)\.c' "$1"; }
LC=""
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
if [ "${1}" == "." ] || [ "${1}" == "*" ] || [ "${1}" == "all" ]
then
	#----------------------------------------
	for FILENAME in *.zig
	do
		#----------------------------------------
		if [ -f "${FILENAME}" ]
		then
			#----------------------------------------
			echo "${FILENAME}:"
			#----------------------------------------
			if [ "${FILENAME}" == "run-tests.zig" ]
			then
				#----------------------------------------
				match_libc ${FILENAME} && LC="-lc"
				#----------------------------------------
				${ZIG} run ${FILENAME} ${LC} -O ${ZIG_BUILD_MODE}
				#----------------------------------------
			else
				#----------------------------------------
				${ZIG} test ${FILENAME} -Doptimize=Debug
				#----------------------------------------
			fi
			#----------------------------------------
			echo
			#----------------------------------------
		fi
		#----------------------------------------
	done
	#--------------------------------------------------------------------------------
	exit 0
	#--------------------------------------------------------------------------------
fi
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
if [ "${1}" != "" ]
then
	#----------------------------------------
	for FILENAME in "$@"
    do
        if [ -f "${FILENAME}" ]
        then
			#----------------------------------------
            echo "${FILENAME}:"
            ${ZIG} test "${FILENAME}" -Doptimize=Debug
            echo
			#----------------------------------------
		elif [ "${FILENAME}" == "run-tests.zig" ]
		then
			#----------------------------------------
			match_libc run-tests.zig && LC="-lc"
			#----------------------------------------
			${ZIG} run run-tests.zig ${LC} -O ${ZIG_BUILD_MODE}
			#----------------------------------------
        elif [ -f "${FILENAME}.zig" ]
        then
			#----------------------------------------
            echo "${FILENAME}.zig:"
            ${ZIG} test "${FILENAME}.zig" -Doptimize=Debug
            echo
			#----------------------------------------
        else
			#----------------------------------------
			echo "invalid source filename: ${FILENAME}"
			exit 1
			#----------------------------------------
		fi
    done
	#--------------------------------------------------------------------------------
	exit 0
	#--------------------------------------------------------------------------------
else
	#--------------------------------------------------------------------------------
	# check for zig files (may be used later)
	#--------------------------------------------------------------------------------
	ZIG_FILE_COUNT=$(ls *.zig 2>/dev/null | wc -l)
	#--------------------------------------------------------------------------------
	if [ -f "run-tests" ]
	then
		#----------------------------------------
		/bin/bash run-tests ${*}
		#----------------------------------------
	elif [ -f "run-tests.zig" ]
	then
		#----------------------------------------
		match_libc run-tests.zig && LC="-lc"
		#----------------------------------------
		${ZIG} run run-tests.zig ${LC} -O ${ZIG_BUILD_MODE}
		#----------------------------------------
	elif [ "${ZIG_FILE_COUNT}" -gt 0 ]
	then
		#----------------------------------------
		for FILENAME in *.zig
		do
			#----------------------------------------
			if [ -f "${FILENAME}" ] && match_test "$FILENAME"
			then
				#----------------------------------------
				echo "${FILENAME}"
				${ZIG} test ${FILENAME} -Doptimize=Debug
	            echo
				#----------------------------------------
			fi
			#----------------------------------------
		done
		#----------------------------------------
	else
		#----------------------------------------
		echo "no zig files found in current directory"
		exit 1
		#----------------------------------------
	fi
	#--------------------------------------------------------------------------------
	exit $?
	#--------------------------------------------------------------------------------
fi
#--------------------------------------------------------------------------------
#################################################################################
#--------------------------------------------------------------------------------
